/**
 * Collection.js is small but yet powerfull localstorage based database.
 *
 * @author Dawid Kraczowski <Crac>
 * @thanks: Dawid Winiarczyk <morriq>
 * @license MIT
 * @version 1.0.0
 */
var Collection=function(){function t(e){return Object.prototype.toString.call(e)==="[object Array]"}function n(e){return typeof e==="object"}function r(e){return typeof e==="function"}function i(e){var r;var s;var o;if(!n(e)||e===null){r=e;return r}if(t(e)){r=[];for(var u=0,a=e.length;u<a;u++){r[u]=i(e[u])}return r}try{r=new e.constructor}catch(f){r={}}for(s in e){if(!e.hasOwnProperty(s)){continue}if(n(e[s])&&e[s]!==null){r[s]=i(e[s])}else{r[s]=e[s]}}return r}function s(e){var t=window.localStorage.getItem(e.name+"_meta");if(t){return JSON.parse(t)}return{name:e.name,length:0,lastId:0,map:[]}}function o(e){window.localStorage.setItem(e.name+"_meta",JSON.stringify(e._meta))}function u(e){if(e._meta.length===0){return[]}var t={};e.length=e._meta.length;for(var r=0;r<e._meta.length;r++){var i=e._meta.map[r];var s=JSON.parse(window.localStorage.getItem(e.name+"_"+i));t[i]=e._unserialize?e._unserialize(s):s;if(!n(t[i])){throw new Error("unserialize function must return an object")}Object.defineProperty(t[i],"_id",{enumerable:false,writable:false,configurable:false,value:i});e[r]=t[i]}return t}function a(e,t){var n=-1;for(var r=0;r<e.length;r++){if(e[r]===t){n=r;break}}if(n===-1){return null}Array.prototype.splice.call(e,n,1);return t}function f(e){Array.prototype.splice.call(e,0,e.length)}function l(e){f(e);var t=0;for(var n in e._data){e[t++]=e._data[n]}e.length=t}function c(e,t,n){var n=r(n)?n:false;var t=r(t)?t:false;Object.defineProperties(this,{name:{enumerable:false,writable:true,value:e},_cursor:{enumerable:false,writable:true,value:0},_meta:{enumerable:false,writable:true,value:{}},_data:{enumerable:false,writable:true,value:{}},_query:{enumerable:false,writable:true,value:null},_serialize:{enumerable:false,writable:false,value:n},_unserialize:{enumerable:false,writable:false,value:t},length:{writable:true,value:0}});this._meta=s(this);this._data=u(this)}try{localStorage.setItem("collection.js",1);localStorage.removeItem("collection.js")}catch(e){throw new Error("Local storage is not supported!")}Object.defineProperties(c.prototype,{id:{enumerable:false,writable:true},save:{enumerable:false,writable:true},remove:{enumerable:false,writable:true},find:{enumerable:false,writable:true},drop:{enumerable:false,writable:true},sort:{enumerable:false,writable:true}});c.prototype.id=function(e){return this._data.hasOwnProperty(e)?this._data[e]:null};c.prototype.save=function(e){var t=r(this._serialize)?this._serialize(i(e)):e;if(!n(t)){throw new Error("serialize function must return object")}if(e._id){if(!this._data.hasOwnProperty(e._id)){throw new Error("Could not find entity with id "+e._id+" in collection "+this.name)}if(e.propertyIsEnumerable("_id")){Object.defineProperty(e,"_id",{enumerable:false,writable:false,value:e._id})}this._data[e._id]=e;for(var s=0;s<this.length;s++){if(this[s]._id===e._id){this[s]=e;break}}window.localStorage.setItem(this.name+"_"+e._id,JSON.stringify(t));return e._id}Object.defineProperty(e,"_id",{enumerable:false,writable:false,configurable:false,value:++this._meta.lastId});this._data[e._id]=e;window.localStorage.setItem(this.name+"_"+e._id,JSON.stringify(t));this._meta.map.push(e._id);if(r(this._query)){if(this._query(e)){this[this.length]=e;this.length++}}else{this[this.length]=e;this.length++}this._meta.length++;o(this);return e._id};c.prototype.remove=function(e){var t;if(n(e)){if(e.hasOwnProperty("_id")){t=e._id}else{return false}}else{t=e}if(!this._data.hasOwnProperty(t)){return false}localStorage.removeItem(this.name+"_"+t);a(this,this._data[t]);delete this._data[t];this._meta.length--;this._meta.map.splice(this._meta.map.indexOf(t),1);o(this)};c.prototype.find=function(e,t){if(!r(e)){if(r(t)){f(this);var n=[];for(var i in this._data){n.push(this._data[i])}n.sort(t);for(var s=0,o=n.length;s<o;s++){this[s]=n[s]}this.length=n.length}else if(this._query===null){return}else{this._query=null;l(this)}return}else{this._query=e}f(this);var n=[];for(var i in this._data){var u=this._data[i];if(this._query(u)){n.push(u)}}if(r(t)){n.sort(t)}for(var s=0,o=n.length;s<n.length;s++){this[s]=n[s]}this.length=n.length};c.prototype.sort=function(e){var t=[];for(var n=0;n<this.length;n++){t.push(this[n])}t.sort(e);f(this);for(var n=0,r=t.length;n<r;n++){this[n]=t[n]}this.length=t.length};c.prototype.drop=function(){for(var e in this._data){localStorage.removeItem(this.name+"_"+e)}localStorage.removeItem(this.name+"_meta");f(this);this._data={};this._meta=s(this)};return c}()